<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>正解率カウンター</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }
    .dashboard {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 20px;
      margin-top: 10px;
      height: 85vh;
    }
    .stats {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 200px;
    }
    .stats div {
      font-size: 14px;
    }
    canvas {
      flex-grow: 1;
      height: 100%;
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      padding: 5px 15px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <label>問題数: <input type="number" id="totalQuestionsInput" min="1" value="10" style="width: 50px;"></label>
    <label>合格ライン（％）: <input type="number" id="passThresholdInput" min="0" max="100" value="80" style="width: 50px;"></label>
    <button onclick="start()">スタート</button>
  </header>

  <div class="dashboard">
    <div class="stats">
      <div>正解: <span id="correctCount">0</span></div>
      <div>不正解: <span id="wrongCount">0</span></div>
      <div>正解率: <span id="accuracy">0</span>%</div>
      <div>進捗: <span id="progress">0</span>/<span id="total">0</span></div>
      <div class="buttons">
        <button onclick="answer(true)">正解</button>
        <button onclick="answer(false)">不正解</button>
      </div>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <dialog id="resultDialog">
    <p id="resultMessage"></p>
    <button onclick="document.getElementById('resultDialog').close()">閉じる</button>
  </dialog>

  <script>
    let correct = 0;
    let wrong = 0;
    let totalQuestions = 10;
    let passThreshold = 80;
    let dataPoints = [];

    const correctCountElem = document.getElementById('correctCount');
    const wrongCountElem = document.getElementById('wrongCount');
    const accuracyElem = document.getElementById('accuracy');
    const progressElem = document.getElementById('progress');
    const totalElem = document.getElementById('total');
    const resultDialog = document.getElementById('resultDialog');
    const resultMessage = document.getElementById('resultMessage');

    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    function start() {
      correct = 0;
      wrong = 0;
      dataPoints = [];
      totalQuestions = parseInt(document.getElementById('totalQuestionsInput').value);
      passThreshold = parseFloat(document.getElementById('passThresholdInput').value);

      correctCountElem.textContent = 0;
      wrongCountElem.textContent = 0;
      accuracyElem.textContent = 0;
      progressElem.textContent = 0;
      totalElem.textContent = totalQuestions;

      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '正解率',
            data: dataPoints,
            borderColor: 'blue',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            annotation: {
              annotations: {
                passLine: {
                  type: 'line',
                  yMin: passThreshold,
                  yMax: passThreshold,
                  borderColor: 'red',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: `合格ライン ${passThreshold}%`,
                    enabled: true,
                    position: 'end',
                    color: 'red',
                    font: {
                      size: 10
                    },
                    backgroundColor: 'rgba(255,255,255,0.7)',
                    padding: 4
                  }
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              min: 0,
              max: totalQuestions,
              title: {
                display: true,
                text: '回答数'
              }
            },
            y: {
              min: 0,
              max: 100,
              title: {
                display: true,
                text: '正解率（％）'
              }
            }
          }
        },
        plugins: [ChartAnnotation]
      });
    }

    function answer(isCorrect) {
      if (correct + wrong >= totalQuestions) return;

      if (isCorrect) correct++;
      else wrong++;

      const total = correct + wrong;
      const accuracy = Math.round((correct / total) * 100);
      correctCountElem.textContent = correct;
      wrongCountElem.textContent = wrong;
      accuracyElem.textContent = accuracy;
      progressElem.textContent = total;

      dataPoints.push({ x: total, y: accuracy });
      chart.update();

      if (total === totalQuestions) {
        if (accuracy >= passThreshold) {
          resultMessage.textContent = "🎉 おめでとう！合格です！";
        } else {
          resultMessage.textContent = "😢 残念、不合格。次は頑張ろう！";
        }
        resultDialog.showModal();
      }
    }
  </script>
</body>
</html>
